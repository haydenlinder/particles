<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:fb="http://ogp.me/ns/fb#">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Particles</title>

    <link rel="stylesheet" href="./index.css">

    <!-- preview -->
    <meta property='og:title' content='Particles' />
    <meta property="og:image" content="//haydenlinder.github.io/particles/preview.jpg" />
    <meta property='og:description' content='An orbital physics simulator.' />
    <meta property='og:url' content='//www.haydenlinder.github.io/haydenlinder' />

    <!-- jquery -->
    <script 
        src="https://code.jquery.com/jquery-3.4.1.slim.js"
        integrity="sha256-BTlTdQO9/fascB1drekrDVkaKd9PkwBymMlHOiG+qLI=" 
        crossorigin="anonymous">
    </script>
    <!-- three.js -->
    <!-- Import maps polyfill -->
    <!-- Remove this when import maps will be widely supported -->
    <script async crossorigin="anonymous" src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
    
</head>
<body>
    <!-- Import maps polyfill -->
    <!-- Remove this when import maps will be widely supported -->
    <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
    
    <script type="importmap">
        {
            "imports": {
                "three": "./node_modules/three/build/three.js"
            }
        }
    </script>
    <!-- dat.gui -->
    <script 
        src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.7/dat.gui.js"
        integrity="sha256-/ROqjaHRlcpmCdy3tSetfsVbS6KcYJo9BEID29zqfYs=" 
        crossorigin="anonymous">
    </script>
    <div class="top">
        <h1>Particles</h1>
        <p class="desc">An orbital physics simulator</p>
        <a href="https://github.com/haydenlinder/particles">
            <img src="git.png" class="git">
        </a>
    </div>
    
    <div id="canvas-container">
        <canvas id="canvas"></canvas>
    </div>

    <!-- entry -->
    <script type="module">
        import * as THREE from "three";

        let loading = document.createElement('div');
        loading.className = 'loading';
        loading.innerText = 'Loading...';

        function setLoading(bool) {
            if (bool) {
                let canvasContainer = document.getElementById('canvas-container');
                canvasContainer.appendChild(loading)
            } else {
                loading.remove();
            }
        };

        class View { 
            constructor({ distance, universeOptions }) {
                this.canvas = document.getElementById('canvas');
                this.universeOptions = universeOptions;
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(
                    75,
                    this.canvas.offsetWidth / this.canvas.offsetHeight,
                    0.1,
                    300000
                );
                this.camera.position.z = distance;
                this.paused = false;

                let ctx = canvas.getContext('webgl');
                ctx.clearColor(0, 1, 1, 1);
                this.canvas.width = canvas.clientWidth;
                this.canvas.height = canvas.clientHeight;

                this.renderer = new THREE.WebGLRenderer({
                    canvas: canvas,
                    canvas: canvas,
                    antialias: true,
                    alpha: true,
                    physicallyCorrectLights: true,
                });
                this.renderer.setViewport(0, 0, canvas.clientWidth, canvas.clientHeight);
                this.renderer.autoClear = false;

                this.composer = new THREE.EffectComposer(this.renderer);
                let renderPass = new THREE.RenderPass(this.scene, this.camera);
                this.composer.addPass(renderPass);

                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);

                this.universe = new Universe({
                    ...universeOptions,
                    scene: this.scene,
                    view: this,
                });

                this.$real_framerate = $("#real_framerate");

                this.lastRendered = new Date();
                this.countFramesPerSecond = 0;
                window.addEventListener('resize',e => this.onWindowResize(this.renderer));
                this.onWindowResize = this.onWindowResize.bind(this)
            }

            onWindowResize() {
                // this.canvas.width = canvas.clientWidth;
                // this.canvas.height = canvas.clientHeight;
                // this.renderer.setViewport(0, 0, window.clientWidth, this.canvas.clientHeight);
                this.camera.aspect = this.canvas.offsetWidth / this.canvas.offsetHeight;
                this.camera.updateProjectionMatrix();
            }

            animate() {
                requestAnimationFrame(this.animate.bind(this));
                // window.addEventListener('resize', this.onWindowResize(), false);
                this.renderer.clear();
                this.renderer.clearDepth();
                this.render();
                this.composer.render(0.1);
                this.renderer.render(this.scene, this.camera);
                
            }

            play_pause() {
                this.paused = this.paused ? false : true ;
            }

            restart() {
                this.scene.children = [];
                this.universe.populate();
                this.universe.light = false;
                if (this.composer) this.composer.dispose();
                this.composer = new THREE.EffectComposer(this.renderer);
                let renderPass = new THREE.RenderPass(this.scene, this.camera);
                this.composer.addPass(renderPass);
                this.center_on_origin()
                document.getElementById('canvas').classList.remove('light');
            }

            center_on_star() {
                if (!this.universe.light) return window.alert("No stars yet. Wait for a star to form to center on it.")
                originButton.classList.remove('selected')
                starButton.classList.add('selected')
                this.scene.children.forEach(child => {
                    if (child.sun) {
                        this.camera.lookAt(child.position);
                        this.target = child.position;
                        this.controls.target = child.position;
                        this.centered = true
                        return true;
                    }
                })
            }

            center_on_origin() {
                if (this.centered) {
                    this.centered = false
                    let pos = new THREE.Vector3(0,0,0)
                    this.camera.lookAt(pos)
                    this.controls.target = pos
                    this.target = null
                    starButton.classList.remove('selected')
                    originButton.classList.add('selected')
                }
            }

            render() {
                if (!this.prevView) this.prevView = this.view_distance;
                if (this.prevView !== this.view_distance) {
                    this.camera.position.z = this.view_distance;
                }

                if (!this.paused) {

                    let now = new Date();
                    if (this.lastRendered && now.getMilliseconds() < this.lastRendered.getMilliseconds()) {
                        this.$real_framerate.html(this.countFramesPerSecond);
                        this.countFramesPerSecond = 1;
                    } else {
                        this.countFramesPerSecond += 1;
                    }

                    this.scene.children.forEach(child => {
                        child.animate();
                        child.updateMass();
                    })

                    if (this.centered) {
                        this.camera.lookAt(this.target);
                        // this.controls.target = this.target;
                    } 

                    this.lastRendered = new Date();
                }
            }
        }

        class Universe {
            constructor({ n, size, heat, density, spread, gravity, scene, view }) {
                this.initial_number_orbs = n;
                this.initial_orb_radius = size;
                this.initial_speed = heat;
                this.initial_spread = spread;
                this.density = density;
                this.gravity = gravity;
                this.view = view;
                this.scene = scene;

                this.totalMass = 0;
                this.suns = 0;
                this.populate();
            }

            defaults() {
                this.view.camera.position.z = 300
                this.initial_number_orbs = 200
                this.initial_orb_radius = 1
                this.initial_speed = 0.005
                this.initial_spread = 30
                this.density = 5520
                this.gravity = 3000
            }

            populate() {
                setLoading(true);
                setTimeout(() => {
                    for (let i = 0; i < this.initial_number_orbs; i++) {
                        let particle = new Particle({
                            radius: this.initial_orb_radius * (Math.random() + 0.1),
                            density: this.density,
                            heat: this.initial_speed,
                            universe: this
                        });
                        particle.position.x = 5 * this.initial_spread * (Math.random() - Math.random());
                        particle.position.y = 5 * this.initial_spread * (Math.random() - Math.random());
                        particle.position.z = 5 * this.initial_spread * (Math.random() - Math.random());
                        
                        this.scene.add(particle);
                        setLoading(false);
                    }
                },100);
            }
        }

        class Particle extends THREE.Mesh {
            constructor({ radius, density, heat, universe }) {
                const mass = density * 4 / 3 * Math.PI * radius ** 3;
                const geometry = new THREE.SphereGeometry(radius + 0.1, 30, 30);
                // const material = new THREE.MeshPhongMaterial({ color: 0x33F9FF, shininess: 0 });
                const material = new THREE.MeshBasicMaterial({ color: 0x00FF00});
                super(geometry, material);

                this.siblings = universe.scene.children
                this.universe = universe;
                this.universe.totalMass += mass

                this.mass = mass;
                this.radius = radius
                this.density = density;
                this.acceleration = new THREE.Vector3();
                this.velocity = new THREE.Vector3(
                    heat * (Math.random() - Math.random()),
                    heat * (Math.random() - Math.random()),
                    heat * (Math.random() - Math.random()),
                )
            }

            animate() {
                this.siblings.forEach(p2 => {
                    p2.updateMass()
                    if (this.uuid !== p2.uuid) {
                        let d = this.position.distanceTo(p2.position)
                        if (d <= this.radius + p2.radius) {
                            this.mass > p2.mass ? this.absorb(p2) : p2.absorb(this)
                        } else {
                            this.gravitate(p2)
                        }
                    }
                });
            }

            absorb(p2) {
                if (p2.sun) {
                    p2.godraysEffect.dispose();
                    this.godraysEffect = new THREE.GodRaysEffect(this.universe.view.camera, this, {
                        resolutionScale: 1,
                        density: 1.5,
                        decay: 0.95,
                        weight: 0.1,
                        samples: 100
                    })
                    let effectPass = new THREE.EffectPass(this.universe.view.camera, this.godraysEffect);
                    effectPass.renderToScreen = true

                    effectPass.uniforms = this.universe.suns
                    this.universe.view.composer.addPass(effectPass);
                }
                let newMass = this.mass + p2.mass;

                let newVelocity = new THREE.Vector3(
                    (this.velocity.x * this.mass + p2.velocity.x * p2.mass) / newMass,
                    (this.velocity.y * this.mass + p2.velocity.y * p2.mass) / newMass,
                    (this.velocity.z * this.mass + p2.velocity.z * p2.mass) / newMass
                );

                let newPos = new THREE.Vector3(
                    (this.position.x * this.mass + p2.position.x * p2.mass) / newMass,
                    (this.position.y * this.mass + p2.position.y * p2.mass) / newMass,
                    (this.position.z * this.mass + p2.position.z * p2.mass) / newMass
                );

                this.position.multiplyScalar(0)
                this.position.add(newPos);
                this.velocity = newVelocity

                let newRadius = (3 * newMass / 4 / this.density / Math.PI) ** (1 / 3)
                this.scale.x *= newRadius / this.radius
                this.scale.y *= newRadius / this.radius
                this.scale.z *= newRadius / this.radius

                this.radius = newRadius;
                this.mass = newMass;
                this.universe.scene.remove(p2)
                this.move();

            }

            gravitate(p2) {
                this.updateMass();
                p2.updateMass();
                let force = new THREE.Vector3().subVectors(this.position, p2.position);
                let d = force.length();
                if (d === 0) return;
                let g = this.universe.gravity * -0.0000000000667408
                let dir = force.normalize();
                let strength = - (g * this.mass * p2.mass) / (d * d);

                force = dir.multiplyScalar(strength);
                this.applyForce(force, -1);
                this.accelerate();
                this.move();
            }

            applyForce(force, dir) {
                this.acceleration = (force.multiplyScalar(dir / this.mass))
            }

            accelerate() {
                this.velocity.add(this.acceleration);
                this.acceleration.multiplyScalar(0);
            }

            move() {
                this.position.add(this.velocity);
            }

            updateMass() {
                if (this.sun) {
                    this.density = this.universe.density / 4
                } else {
                    this.density = this.universe.density
                    if (!this.colored && this.universe.light) {
                        this.material = new THREE.MeshPhongMaterial({ color: 0x33F9FF, shininess: 0 });
                        this.colored = true;
                    }
                } if (this.mass > 1000000) {//this.universe.totalMass/3){
                    if (!this.sun) {
                        this.density *= 1 / 4;
                        this.material = new THREE.MeshBasicMaterial({ color: 'yellow' })

                        let light = new THREE.PointLight({
                            color: 'yellow',
                            distance: 2,
                            decay: 2
                        });
                        this.add(light);

                        let canvas = document.getElementById('canvas')
                        canvas.classList.add('light')
                        this.universe.light = true;

                        this.godraysEffect = new THREE.GodRaysEffect(this.universe.view.camera, this, {
                            resolutionScale: 1,
                            density: 1.5,
                            decay: 0.95,
                            weight: 0.1,
                            samples: 100
                        })
                        this.godraysEffect.bur = true;
                        let effectPass = new THREE.EffectPass(this.universe.view.camera, this.godraysEffect);
                        effectPass.renderToScreen = true

                        effectPass.uniforms = this.universe.suns
                        this.universe.view.composer.addPass(effectPass);

                        this.sun = true
                        this.universe.suns += 1;
                    }
                    this.children[0].intensity = 0.0000005 * this.mass;
                }
            }
        }

        let options = {
            distance: 500,
            universeOptions: {
                n: 250,
                size: 1.7,
                heat: 0.005,
                spread: 60,
                density: 5520,
                gravity: 3000,
            }
        }

        const view = new View({
            distance: options.distance,
            universeOptions: options.universeOptions
        });

        let canvasContainer = document.getElementById('canvas-container')
        
        let playControlText = document.createElement('div')
        playControlText.innerText = 'play'
        let playButtonText = document.createElement('div')
        playButtonText.innerText = '▶' 
        let playButton = document.createElement('div')
        playButton.className = 'button-container'
        playButton.onclick = e => {
            view.play_pause();
            playButtonText.innerText = view.paused ? '▶' : '||'
            playControlText.innerText = view.paused ? 'play' : 'pause'
        }
        playButton.appendChild(playButtonText);
        let playControl = document.createElement('div');
        playControl.className = 'controler';
        playControl.appendChild(playButton);
        playControl.appendChild(playControlText);
        
        let restartControlText = document.createElement('div')
        restartControlText.innerText = 'restart'
        let restartText = document.createElement('div')
        restartText.innerText = '↻' 
        let restartButton = document.createElement('div')
        restartButton.className = 'button-container'
        restartButton.onclick = e => {
            setLoading(true);
            view.restart();
        }
        restartButton.appendChild(restartText);
        let restartControl = document.createElement('div');
        restartControl.className = 'controler';
        restartControl.appendChild(restartButton);
        restartControl.appendChild(restartControlText);

        let originControlText = document.createElement('div')
        originControlText.innerText = 'origin'
        let originText = document.createElement('div')
        originText.innerText = '◎' 
        let originButton = document.createElement('div')
        originButton.className = 'button-container selected'
        originButton.onclick = e => {
            view.center_on_origin();
        }
        originButton.appendChild(originText);
        let originControl = document.createElement('div');
        originControl.className = 'controler';
        originControl.appendChild(originButton);
        originControl.appendChild(originControlText);

        let starControlText = document.createElement('div')
        starControlText.innerText = 'star'
        let starText = document.createElement('div')
        starText.innerText = '☀' 
        let starButton = document.createElement('div')
        starButton.id = 'star-button'
        starButton.className = 'button-container'
        starButton.onclick = e => {
            view.center_on_star();
        }
        starButton.appendChild(starText);
        starButton.appendChild(starText);
        let starControl = document.createElement('div');
        starControl.className = 'controler';
        starControl.appendChild(starButton);
        starControl.appendChild(starControlText);

        let gravityControlText = document.createElement('div')
        gravityControlText.innerText = `gravity: ${view.universe.gravity}`
        let gravitySliderContainer = document.createElement('div')
        gravitySliderContainer.className = 'slider-container'
        let x = 0;
        gravitySliderContainer.ontouchmove = e => {
            x = e.touches.item(0).pageX
            const rect = gravitySlider.getBoundingClientRect()
            const width = x - rect.x
            if (width > gravitySliderContainer.offsetWidth) {
                view.universe.gravity = 10000;
                gravitySlider.style.width = '100%';
                gravityControlText.innerText = `gravity: ${view.universe.gravity.toFixed(0)}`;
                return null
            }
            if (width < 0) {
                view.universe.gravity = 0;
                gravitySlider.style.width = 0 + 'px';
                gravityControlText.innerText = `gravity: ${view.universe.gravity.toFixed(0)}`;
                return null
            }
            gravitySlider.style.width = width + 'px';
            view.universe.gravity = 10000 * width / gravitySliderContainer.offsetWidth;
            gravityControlText.innerText = `gravity: ${view.universe.gravity.toFixed(0)}`;
        }
        gravitySliderContainer.onmousedown = e => {
            x = e.pageX;
            const rect = gravitySlider.getBoundingClientRect()
            const width = x - rect.x
            if (width > gravitySliderContainer.offsetWidth) {
                view.universe.gravity = 10000;
                gravitySlider.style.width = '100%';
                gravityControlText.innerText = `gravity: ${view.universe.gravity.toFixed(0)}`;
                return null
            }
            if (width < 0) {
                view.universe.gravity = 0;
                gravitySlider.style.width = 0 + 'px';
                gravityControlText.innerText = `gravity: ${view.universe.gravity.toFixed(0)}`;
                return null
            }
            gravitySlider.style.width = width + 'px';
            view.universe.gravity = 10000 * width/gravitySliderContainer.offsetWidth; 
            gravityControlText.innerText = `gravity: ${view.universe.gravity.toFixed(0)}`;
        }
        document.addEventListener('mousemove', e => {
            if (x) {
                const rect = gravitySlider.getBoundingClientRect()
                const width = e.pageX - rect.x
                if (width > gravitySliderContainer.offsetWidth) {
                    view.universe.gravity = 10000;
                    gravitySlider.style.width = '100%';
                    gravityControlText.innerText = `gravity: ${view.universe.gravity.toFixed(0)}`;
                    return null
                }
                if (width < 0) {
                    view.universe.gravity = 0;
                    gravitySlider.style.width = 0 + 'px';
                    gravityControlText.innerText = `gravity: ${view.universe.gravity.toFixed(0)}`;
                    return null
                }                
                gravitySlider.style.width = width + 'px';
                view.universe.gravity = 10000 * width/gravitySliderContainer.offsetWidth; 
                gravityControlText.innerText = `gravity: ${view.universe.gravity.toFixed(0)}`;
            }
        })
        document.addEventListener('mouseup', e => x = 0);
        let gravitySlider = document.createElement('div')
        gravitySlider.className = 'slider'
        gravitySlider.style.width = 100*view.universe.gravity/10000 + '%'
        gravitySliderContainer.appendChild(gravitySlider);
        let gravityControl = document.createElement('div');
        gravityControl.className = 'controler';
        gravityControl.appendChild(gravitySliderContainer);
        gravityControl.appendChild(gravityControlText);

        let densityControlText = document.createElement('div')
        densityControlText.innerText = `initial density: ${view.universe.density}`
        let densitySliderContainer = document.createElement('div')
        densitySliderContainer.className = 'slider-container initial'
        let x2 = 0;
        densitySliderContainer.ontouchmove = e => {
            x2 = e.touches.item(0).pageX
            const rect = densitySlider.getBoundingClientRect()
            const width = x2 - rect.x
            if (width > densitySliderContainer.offsetWidth) {
                view.universe.density = 9000;
                densitySlider.style.width = '100%';
                densityControlText.innerText = `initial density: ${view.universe.density.toFixed(0)}`;
                return null
            }
            if (width < 1) {
                view.universe.density = 1;
                densitySlider.style.width = 0 + 'px';
                densityControlText.innerText = `initial density: ${view.universe.density.toFixed(0)}`;
                return null
            }
            densitySlider.style.width = width + 'px';
            view.universe.density = 9000 * width/densitySliderContainer.offsetWidth; 
            densityControlText.innerText = `initial density: ${view.universe.density.toFixed(0)}`;
        }
        densitySliderContainer.onmousedown = e => {
            x2 = e.pageX;
            const rect = densitySlider.getBoundingClientRect()
            const width = x2 - rect.x
            if (width > densitySliderContainer.offsetWidth) {
                view.universe.density = 9000;
                densitySlider.style.width = '100%';
                densityControlText.innerText = `initial density: ${view.universe.density.toFixed(0)}`;
                return null
            }
            if (width < 1) {
                view.universe.density = 1;
                densitySlider.style.width = 0 + 'px';
                densityControlText.innerText = `initial density: ${view.universe.density.toFixed(0)}`;
                return null
            }
            densitySlider.style.width = width + 'px';
            view.universe.density = 9000 * width/densitySliderContainer.offsetWidth; 
            densityControlText.innerText = `initial density: ${view.universe.density.toFixed(0)}`;
        }
        document.addEventListener('mousemove', e => {
            if (x2) {
                const rect = densitySlider.getBoundingClientRect()
                const width = e.pageX - rect.x
                if (width > densitySliderContainer.offsetWidth) {
                    view.universe.density = 9000;
                    densitySlider.style.width = '100%';
                    densityControlText.innerText = `initial density: ${view.universe.density.toFixed(0)}`;
                    return null
                }
                if (width < 1) {
                    view.universe.density = 1;
                    densitySlider.style.width = 0 + 'px';
                    densityControlText.innerText = `initial density: ${view.universe.density.toFixed(0)}`;
                    return null
                }                
                densitySlider.style.width = width + 'px';
                view.universe.density = 9000 * width/densitySliderContainer.offsetWidth; 
                densityControlText.innerText = `initial density: ${view.universe.density.toFixed(0)}`;
            }
        })
        document.addEventListener('mouseup', e => x2 = 0);
        let densitySlider = document.createElement('div')
        densitySlider.className = 'slider'
        densitySlider.style.width = 100*view.universe.density/9000 + '%'
        densitySliderContainer.appendChild(densitySlider);
        let densityControl = document.createElement('div');
        densityControl.className = 'controler';
        densityControl.appendChild(densitySliderContainer);
        densityControl.appendChild(densityControlText);

        let spreadControlText = document.createElement('div')
        spreadControlText.innerText = `initial spread: ${view.universe.initial_spread}`
        let spreadSliderContainer = document.createElement('div')
        spreadSliderContainer.className = 'slider-container initial'
        let x3 = 0;
        spreadSliderContainer.ontouchmove = e => {
            x3 = e.touches.item(0).pageX
            const rect = spreadSlider.getBoundingClientRect()
            const width = x3 - rect.x
            if (width > spreadSliderContainer.offsetWidth) {
                view.universe.initial_spread = 1000;
                spreadSlider.style.width = '100%';
                spreadControlText.innerText = `initial spread: ${view.universe.initial_spread.toFixed(0)}`;
                return null
            }
            if (width < 1) {
                view.universe.initial_spread = 1;
                spreadSlider.style.width = 0 + 'px';
                spreadControlText.innerText = `initial spread: ${view.universe.initial_spread.toFixed(0)}`;
                return null
            }
            spreadSlider.style.width = width + 'px';
            view.universe.initial_spread = 1000 * width/spreadSliderContainer.offsetWidth; 
            spreadControlText.innerText = `initial spread: ${view.universe.initial_spread.toFixed(0)}`;
        }
        spreadSliderContainer.onmousedown = e => {
            x3 = e.pageX;
            const rect = spreadSlider.getBoundingClientRect()
            const width = x3 - rect.x
            if (width > spreadSliderContainer.offsetWidth) {
                view.universe.initial_spread = 1000;
                spreadSlider.style.width = '100%';
                spreadControlText.innerText = `initial spread: ${view.universe.initial_spread.toFixed(0)}`;
                return null
            }
            if (width < 1) {
                view.universe.initial_spread = 1;
                spreadSlider.style.width = 0 + 'px';
                spreadControlText.innerText = `initial spread: ${view.universe.initial_spread.toFixed(0)}`;
                return null
            }
            spreadSlider.style.width = width + 'px';
            view.universe.initial_spread = 1000 * width/spreadSliderContainer.offsetWidth; 
            spreadControlText.innerText = `initial spread: ${view.universe.initial_spread.toFixed(0)}`;
        }
        document.addEventListener('mousemove', e => {
            if (x3) {
                const rect = spreadSlider.getBoundingClientRect()
                const width = e.pageX - rect.x
                if (width > spreadSliderContainer.offsetWidth) {
                    view.universe.initial_spread = 1000;
                    spreadSlider.style.width = '100%';
                    spreadControlText.innerText = `initial spread: ${view.universe.initial_spread.toFixed(0)}`;
                    return null
                }
                if (width < 1) {
                    view.universe.initial_spread = 1;
                    spreadSlider.style.width = 0 + 'px';
                    spreadControlText.innerText = `initial spread: ${view.universe.initial_spread.toFixed(0)}`;
                    return null
                }                
                spreadSlider.style.width = width + 'px';
                view.universe.initial_spread = 1000 * width/spreadSliderContainer.offsetWidth; 
                spreadControlText.innerText = `initial spread: ${view.universe.initial_spread.toFixed(0)}`;
            }
        })
        document.addEventListener('mouseup', e => x3 = 0);
        let spreadSlider = document.createElement('div')
        spreadSlider.className = 'slider'
        spreadSlider.style.width = 100*view.universe.initial_spread/1000 + '%'
        spreadSliderContainer.appendChild(spreadSlider);
        let spreadControl = document.createElement('div');
        spreadControl.className = 'controler';
        spreadControl.appendChild(spreadSliderContainer);
        spreadControl.appendChild(spreadControlText);

        let speedControlText = document.createElement('div')
        speedControlText.innerText = `initial speed: ${view.universe.initial_speed}`
        let speedSliderContainer = document.createElement('div')
        speedSliderContainer.className = 'slider-container initial'
        let x4 = 0;
        speedSliderContainer.ontouchmove = e => {
            x4 = e.touches.item(0).pageX
            const rect = speedSlider.getBoundingClientRect()
            const width = x4 - rect.x
            if (width > speedSliderContainer.offsetWidth) {
                view.universe.initial_speed = 0.1;
                speedSlider.style.width = '100%';
                speedControlText.innerText = `initial speed: ${view.universe.initial_speed.toFixed(4)}`;
                return null
            }
            if (width < 1) {
                view.universe.initial_speed = 0;
                speedSlider.style.width = 0 + 'px';
                speedControlText.innerText = `initial speed: ${view.universe.initial_speed.toFixed(4)}`;
                return null
            }
            speedSlider.style.width = width + 'px';
            view.universe.initial_speed = 0.1 * width/speedSliderContainer.offsetWidth; 
            speedControlText.innerText = `initial speed: ${view.universe.initial_speed.toFixed(4)}`;
        }
        speedSliderContainer.onmousedown = e => {
            x4 = e.pageX;
            const rect = speedSlider.getBoundingClientRect()
            const width = x4 - rect.x
            if (width > speedSliderContainer.offsetWidth) {
                view.universe.initial_speed = 0.1;
                speedSlider.style.width = '100%';
                speedControlText.innerText = `initial speed: ${view.universe.initial_speed.toFixed(4)}`;
                return null
            }
            if (width < 1) {
                view.universe.initial_speed = 0;
                speedSlider.style.width = 0 + 'px';
                speedControlText.innerText = `initial speed: ${view.universe.initial_speed.toFixed(4)}`;
                return null
            }
            speedSlider.style.width = width + 'px';
            view.universe.initial_speed = 0.1 * width/speedSliderContainer.offsetWidth; 
            speedControlText.innerText = `initial speed: ${view.universe.initial_speed.toFixed(4)}`;
        }
        document.addEventListener('mousemove', e => {
            if (x4) {
                const rect = speedSlider.getBoundingClientRect()
                const width = e.pageX - rect.x
                if (width > speedSliderContainer.offsetWidth) {
                    view.universe.initial_speed = 0.1;
                    speedSlider.style.width = '100%';
                    speedControlText.innerText = `initial speed: ${view.universe.initial_speed.toFixed(4)}`;
                    return null
                }
                if (width < 1) {
                    view.universe.initial_speed = 0;
                    speedSlider.style.width = 0 + 'px';
                    speedControlText.innerText = `initial speed: ${view.universe.initial_speed.toFixed(4)}`;
                    return null
                }                
                speedSlider.style.width = width + 'px';
                view.universe.initial_speed = 0.1 * width/speedSliderContainer.offsetWidth; 
                speedControlText.innerText = `initial speed: ${view.universe.initial_speed.toFixed(4)}`;
            }
        })
        document.addEventListener('mouseup', e => x4 = 0);
        let speedSlider = document.createElement('div')
        speedSlider.className = 'slider'
        speedSlider.style.width = 100*view.universe.initial_speed/0.1 + '%'
        speedSliderContainer.appendChild(speedSlider);
        let speedControl = document.createElement('div');
        speedControl.className = 'controler';
        speedControl.appendChild(speedSliderContainer);
        speedControl.appendChild(speedControlText);

        let countControlText = document.createElement('div')
        countControlText.innerText = `initial count: ${view.universe.initial_number_orbs}`
        let countSliderContainer = document.createElement('div')
        countSliderContainer.className = 'slider-container initial'
        let x5 = 0;
        countSliderContainer.ontouchmove = e => {
            x5 = e.touches.item(0).pageX
            const rect = countSlider.getBoundingClientRect()
            const width = x5 - rect.x
            if (width > countSliderContainer.offsetWidth) {
                view.universe.initial_number_orbs = 500;
                countSlider.style.width = '100%';
                countControlText.innerText = `initial count: ${view.universe.initial_number_orbs.toFixed(0)}`;
                return null
            }
            if (width < 1) {
                view.universe.initial_number_orbs = 2;
                countSlider.style.width = 0 + 'px';
                countControlText.innerText = `initial count: ${view.universe.initial_number_orbs.toFixed(0)}`;
                return null
            }
            countSlider.style.width = width + 'px';
            view.universe.initial_number_orbs = 500 * width/countSliderContainer.offsetWidth; 
            countControlText.innerText = `initial count: ${view.universe.initial_number_orbs.toFixed(0)}`;
        }
        countSliderContainer.onmousedown = e => {
            x5 = e.pageX;
            const rect = countSlider.getBoundingClientRect()
            const width = x5 - rect.x
            if (width > countSliderContainer.offsetWidth) {
                view.universe.initial_number_orbs = 500;
                countSlider.style.width = '100%';
                countControlText.innerText = `initial count: ${view.universe.initial_number_orbs.toFixed(0)}`;
                return null
            }
            if (width < 1) {
                view.universe.initial_number_orbs = 2;
                countSlider.style.width = 0 + 'px';
                countControlText.innerText = `initial count: ${view.universe.initial_number_orbs.toFixed(0)}`;
                return null
            }
            countSlider.style.width = width + 'px';
            view.universe.initial_number_orbs = 500 * width/countSliderContainer.offsetWidth; 
            countControlText.innerText = `initial count: ${view.universe.initial_number_orbs.toFixed(0)}`;
        }
        document.addEventListener('mousemove', e => {
            if (x5) {
                const rect = countSlider.getBoundingClientRect()
                const width = e.pageX - rect.x
                if (width > countSliderContainer.offsetWidth) {
                    view.universe.initial_number_orbs = 500;
                    countSlider.style.width = '100%';
                    countControlText.innerText = `initial count: ${view.universe.initial_number_orbs.toFixed(0)}`;
                    return null
                }
                if (width < 1) {
                    view.universe.initial_number_orbs = 2;
                    countSlider.style.width = 0 + 'px';
                    countControlText.innerText = `initial count: ${view.universe.initial_number_orbs.toFixed(0)}`;
                    return null
                }                
                countSlider.style.width = width + 'px';
                view.universe.initial_number_orbs = 500 * width/countSliderContainer.offsetWidth; 
                countControlText.innerText = `initial count: ${view.universe.initial_number_orbs.toFixed(0)}`;
            }
        })
        document.addEventListener('mouseup', e => x5 = 0);
        let countSlider = document.createElement('div')
        countSlider.className = 'slider'
        countSlider.style.width = 100*view.universe.initial_number_orbs/500 + '%'
        countSliderContainer.appendChild(countSlider);
        let countControl = document.createElement('div');
        countControl.className = 'controler';
        countControl.appendChild(countSliderContainer);
        countControl.appendChild(countControlText);

        document.ontouchend = e => {
            x = 0;
            x2 = 0;
            x3 = 0;
            x4 = 0;
            x5 = 0;
        }

        document.onmouseup = e => {
            x = 0;
            x2 = 0;
            x3 = 0;
            x4 = 0;
            x5 = 0;
        }

        let controls = document.createElement('div');
        controls.className = 'controls'
        // controls.appendChild(gravityControl)
        // controls.appendChild(densityControl)
        // controls.appendChild(spreadControl)
        // controls.appendChild(speedControl)
        // controls.appendChild(countControl)

        let controlsVisible = false;
        let toggleControls = document.createElement('div')
        toggleControls.innerText = '⫯⫰⫱'
        toggleControls.className = 'toggle-controls'
        toggleControls.onclick = e => {
            if (controlsVisible) {
                // controls.remove();
                gravityControl.remove()
                densityControl.remove()
                spreadControl.remove()
                speedControl.remove()
                countControl.remove()
                controlsVisible = false;
                toggleControls.innerText = '⫯⫰⫱'
            } else {
                controls.appendChild(gravityControl)
                controls.appendChild(densityControl)
                controls.appendChild(spreadControl)
                controls.appendChild(speedControl)
                controls.appendChild(countControl)
                controlsVisible = true
                toggleControls.innerText = ' x '
            }
        }

        controls.appendChild(toggleControls)

        controls.appendChild(playControl)
        controls.appendChild(restartControl)
        controls.appendChild(originControl)
        controls.appendChild(starControl)
        let alert = true;

        canvasContainer.appendChild(controls)
        let sliders = document.getElementsByClassName('slider-container initial');
        for (let i = 0; i < sliders.length; i++) {
            sliders[i].addEventListener('click', () => {
                if (alert) {
                    window.alert("Remember, you'll need to click 'restart' for initial conditions to take effect.");
                    alert = false;
                }

            })
        }

        view.animate();
        view.play_pause();
    </script>

</body>
</html>